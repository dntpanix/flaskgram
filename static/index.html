<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlaskGram</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Satisfy&display=swap');
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        const { Camera, Heart, MessageCircle, Send, Bookmark, Home, PlusSquare, User, Settings, MoreHorizontal } = lucide;

        const API_URL = 'http://127.0.0.1:5000';

        function InstagramClone() {
          const [view, setView] = useState('login');
          const [token, setToken] = useState(null);
          const [user, setUser] = useState(null);
          const [posts, setPosts] = useState([]);
          const [loading, setLoading] = useState(false);
          
          const [loginData, setLoginData] = useState({ email: '', password: '' });
          const [signupData, setSignupData] = useState({ username: '', email: '', password: '', confirm_password: '' });
          const [newPost, setNewPost] = useState({ caption: '', image_url: '' });
          const [error, setError] = useState('');
          const [success, setSuccess] = useState('');

          useEffect(() => {
            if (token) {
              fetchUserProfile();
              fetchPosts();
              setView('home');
            }
          }, [token]);

          const handleLogin = async () => {
            setError('');
            setLoading(true);
            
            try {
              const response = await fetch(`${API_URL}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(loginData)
              });
              
              const data = await response.json();
              
              if (response.ok) {
                setToken(data.token);
                setSuccess('Login successful!');
                setView('home');
              } else {
                setError(data.msg || 'Login failed');
              }
            } catch (err) {
              setError('Connection error. Make sure Flask server is running on port 5000');
            } finally {
              setLoading(false);
            }
          };

          const handleSignup = async () => {
            setError('');
            setLoading(true);
            
            if (signupData.password !== signupData.confirm_password) {
              setError('Passwords do not match');
              setLoading(false);
              return;
            }
            
            try {
              const response = await fetch(`${API_URL}/signup`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(signupData)
              });
              
              const data = await response.json();
              
              if (response.ok) {
                setSuccess('Account created! Please login.');
                setView('login');
              } else {
                setError(data.msg || 'Signup failed');
              }
            } catch (err) {
              setError('Connection error. Make sure Flask server is running on port 5000');
            } finally {
              setLoading(false);
            }
          };

          const fetchUserProfile = async () => {
            try {
              const response = await fetch(`${API_URL}/user/me`, {
                headers: { 'Authorization': `Bearer ${token}` }
              });
              
              if (response.ok) {
                const data = await response.json();
                setUser(data);
              }
            } catch (err) {
              console.error('Failed to fetch user profile');
            }
          };

          const fetchPosts = async () => {
            try {
              const response = await fetch(`${API_URL}/posts`, {
                headers: { 'Authorization': `Bearer ${token}` }
              });
              
              if (response.ok) {
                const data = await response.json();
                setPosts(data.posts || []);
              }
            } catch (err) {
              console.error('Failed to fetch posts');
            }
          };

          const createPost = async () => {
            setError('');
            setLoading(true);
            
            try {
              const response = await fetch(`${API_URL}/posts`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(newPost)
              });
              
              if (response.ok) {
                setSuccess('Post created!');
                setNewPost({ caption: '', image_url: '' });
                fetchPosts();
                setView('home');
              } else {
                const data = await response.json();
                setError(data.msg || 'Failed to create post');
              }
            } catch (err) {
              setError('Connection error');
            } finally {
              setLoading(false);
            }
          };

          const logout = () => {
            setToken(null);
            setUser(null);
            setPosts([]);
            setView('login');
          };

          const Icon = ({ icon: IconComponent, ...props }) => {
            return React.createElement(IconComponent, props);
          };

          if (!token) {
            return (
              <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
                <div className="w-full max-w-sm">
                  <div className="bg-white border border-gray-300 p-10 mb-3">
                    <div className="text-center mb-8">
                      <h1 className="font-bold text-4xl mb-8" style={{ fontFamily: 'Satisfy, cursive' }}>FlaskGram</h1>
                    </div>

                    {error && (
                      <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4 text-sm">
                        {error}
                      </div>
                    )}

                    {success && (
                      <div className="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded mb-4 text-sm">
                        {success}
                      </div>
                    )}

                    {view === 'login' ? (
                      <div className="space-y-2">
                        <input
                          type="email"
                          placeholder="Email"
                          value={loginData.email}
                          onChange={(e) => setLoginData({ ...loginData, email: e.target.value })}
                          onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                          className="w-full px-3 py-2 border border-gray-300 rounded text-sm bg-gray-50 focus:outline-none focus:border-gray-400"
                        />
                        <input
                          type="password"
                          placeholder="Password"
                          value={loginData.password}
                          onChange={(e) => setLoginData({ ...loginData, password: e.target.value })}
                          onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                          className="w-full px-3 py-2 border border-gray-300 rounded text-sm bg-gray-50 focus:outline-none focus:border-gray-400"
                        />
                        <button
                          onClick={handleLogin}
                          disabled={loading}
                          className="w-full bg-blue-500 text-white py-2 rounded font-semibold text-sm hover:bg-blue-600 disabled:bg-blue-300 mt-3"
                        >
                          {loading ? 'Loading...' : 'Log In'}
                        </button>
                      </div>
                    ) : (
                      <div className="space-y-2">
                        <input
                          type="text"
                          placeholder="Username"
                          value={signupData.username}
                          onChange={(e) => setSignupData({ ...signupData, username: e.target.value })}
                          className="w-full px-3 py-2 border border-gray-300 rounded text-sm bg-gray-50 focus:outline-none focus:border-gray-400"
                        />
                        <input
                          type="email"
                          placeholder="Email"
                          value={signupData.email}
                          onChange={(e) => setSignupData({ ...signupData, email: e.target.value })}
                          className="w-full px-3 py-2 border border-gray-300 rounded text-sm bg-gray-50 focus:outline-none focus:border-gray-400"
                        />
                        <input
                          type="password"
                          placeholder="Password"
                          value={signupData.password}
                          onChange={(e) => setSignupData({ ...signupData, password: e.target.value })}
                          className="w-full px-3 py-2 border border-gray-300 rounded text-sm bg-gray-50 focus:outline-none focus:border-gray-400"
                        />
                        <input
                          type="password"
                          placeholder="Confirm Password"
                          value={signupData.confirm_password}
                          onChange={(e) => setSignupData({ ...signupData, confirm_password: e.target.value })}
                          onKeyPress={(e) => e.key === 'Enter' && handleSignup()}
                          className="w-full px-3 py-2 border border-gray-300 rounded text-sm bg-gray-50 focus:outline-none focus:border-gray-400"
                        />
                        <button
                          onClick={handleSignup}
                          disabled={loading}
                          className="w-full bg-blue-500 text-white py-2 rounded font-semibold text-sm hover:bg-blue-600 disabled:bg-blue-300 mt-3"
                        >
                          {loading ? 'Loading...' : 'Sign Up'}
                        </button>
                      </div>
                    )}
                  </div>

                  <div className="bg-white border border-gray-300 p-5 text-center">
                    <p className="text-sm">
                      {view === 'login' ? "Don't have an account? " : "Have an account? "}
                      <button
                        onClick={() => {
                          setView(view === 'login' ? 'signup' : 'login');
                          setError('');
                          setSuccess('');
                        }}
                        className="text-blue-500 font-semibold"
                      >
                        {view === 'login' ? 'Sign up' : 'Log in'}
                      </button>
                    </p>
                  </div>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gray-50">
              <header className="bg-white border-b border-gray-300 sticky top-0 z-50">
                <div className="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
                  <h1 className="font-bold text-2xl" style={{ fontFamily: 'Satisfy, cursive' }}>FlaskGram</h1>
                  
                  <div className="flex items-center gap-6">
                    <button onClick={() => setView('home')} className={view === 'home' ? 'text-black' : 'text-gray-400'}>
                      <Icon icon={Home} size={24} />
                    </button>
                    <button onClick={() => setView('create')} className={view === 'create' ? 'text-black' : 'text-gray-400'}>
                      <Icon icon={PlusSquare} size={24} />
                    </button>
                    <button onClick={() => setView('profile')} className={view === 'profile' ? 'text-black' : 'text-gray-400'}>
                      <Icon icon={User} size={24} />
                    </button>
                    <button onClick={logout} className="text-gray-600 hover:text-black">
                      <Icon icon={Settings} size={24} />
                    </button>
                  </div>
                </div>
              </header>

              <main className="max-w-5xl mx-auto px-4 py-8">
                {view === 'home' && (
                  <div className="max-w-xl mx-auto">
                    {posts.length === 0 ? (
                      <div className="bg-white border border-gray-300 rounded-lg p-8 text-center">
                        <Icon icon={Camera} size={48} className="mx-auto mb-4 text-gray-400" />
                        <h3 className="font-semibold text-xl mb-2">No Posts Yet</h3>
                        <p className="text-gray-500 mb-4">Start by creating your first post!</p>
                        <button
                          onClick={() => setView('create')}
                          className="bg-blue-500 text-white px-6 py-2 rounded font-semibold hover:bg-blue-600"
                        >
                          Create Post
                        </button>
                      </div>
                    ) : (
                      <div className="space-y-6">
                        {posts.map((post, idx) => (
                          <div key={idx} className="bg-white border border-gray-300 rounded-lg">
                            <div className="flex items-center justify-between p-3">
                              <div className="flex items-center gap-3">
                                <div className="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white font-semibold">
                                  {post.author?.username?.[0]?.toUpperCase() || 'U'}
                                </div>
                                <span className="font-semibold text-sm">{post.author?.username || 'User'}</span>
                              </div>
                              <button><Icon icon={MoreHorizontal} size={20} /></button>
                            </div>
                            
                            <div className="w-full aspect-square bg-gray-100 flex items-center justify-center">
                              {post.image_url ? (
                                <img src={post.image_url} alt={post.caption} className="w-full h-full object-cover" />
                              ) : (
                                <Icon icon={Camera} size={48} className="text-gray-400" />
                              )}
                            </div>
                            
                            <div className="p-3">
                              <div className="flex items-center gap-4 mb-3">
                                <button className="hover:text-gray-500"><Icon icon={Heart} size={24} /></button>
                                <button className="hover:text-gray-500"><Icon icon={MessageCircle} size={24} /></button>
                                <button className="hover:text-gray-500"><Icon icon={Send} size={24} /></button>
                                <button className="hover:text-gray-500 ml-auto"><Icon icon={Bookmark} size={24} /></button>
                              </div>
                              
                              {post.likes > 0 && (
                                <p className="font-semibold text-sm mb-2">{post.likes} likes</p>
                              )}
                              
                              {post.caption && (
                                <p className="text-sm">
                                  <span className="font-semibold mr-2">{post.author?.username || 'User'}</span>
                                  {post.caption}
                                </p>
                              )}
                              
                              {post.timestamp && (
                                <p className="text-xs text-gray-400 mt-2">
                                  {new Date(post.timestamp).toLocaleDateString()}
                                </p>
                              )}
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                )}

                {view === 'create' && (
                  <div className="max-w-xl mx-auto">
                    <div className="bg-white border border-gray-300 rounded-lg p-6">
                      <h2 className="text-xl font-semibold mb-6">Create New Post</h2>
                      
                      {error && (
                        <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4 text-sm">
                          {error}
                        </div>
                      )}

                      {success && (
                        <div className="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded mb-4 text-sm">
                          {success}
                        </div>
                      )}
                      
                      <div className="space-y-4">
                        <div>
                          <label className="block text-sm font-semibold mb-2">Image URL</label>
                          <input
                            type="url"
                            placeholder="https://example.com/image.jpg"
                            value={newPost.image_url}
                            onChange={(e) => setNewPost({ ...newPost, image_url: e.target.value })}
                            className="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-gray-400"
                          />
                        </div>
                        
                        <div>
                          <label className="block text-sm font-semibold mb-2">Caption</label>
                          <textarea
                            placeholder="Write a caption..."
                            value={newPost.caption}
                            onChange={(e) => setNewPost({ ...newPost, caption: e.target.value })}
                            className="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-gray-400 resize-none"
                            rows="4"
                          />
                        </div>
                        
                        <button
                          onClick={createPost}
                          disabled={loading}
                          className="w-full bg-blue-500 text-white py-2 rounded font-semibold hover:bg-blue-600 disabled:bg-blue-300"
                        >
                          {loading ? 'Posting...' : 'Share'}
                        </button>
                      </div>
                    </div>
                  </div>
                )}

                {view === 'profile' && (
                  <div className="max-w-4xl mx-auto">
                    <div className="bg-white border border-gray-300 rounded-lg p-8">
                      <div className="flex items-center gap-8 mb-8">
                        <div className="w-32 h-32 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white text-4xl font-bold">
                          {user?.username?.[0]?.toUpperCase() || 'U'}
                        </div>
                        
                        <div className="flex-1">
                          <div className="flex items-center gap-4 mb-4">
                            <h2 className="text-2xl">{user?.username || 'Username'}</h2>
                            <button className="bg-gray-100 px-4 py-1 rounded font-semibold text-sm hover:bg-gray-200">
                              Edit Profile
                            </button>
                            <button onClick={logout} className="bg-gray-100 px-4 py-1 rounded font-semibold text-sm hover:bg-gray-200">
                              Logout
                            </button>
                          </div>
                          
                          <div className="flex gap-8 mb-4">
                            <span><strong>{posts.length}</strong> posts</span>
                            <span><strong>{user?.followers || 0}</strong> followers</span>
                            <span><strong>{user?.following || 0}</strong> following</span>
                          </div>
                          
                          <div>
                            <p className="font-semibold">{user?.name || user?.username}</p>
                            <p className="text-sm text-gray-600">{user?.email}</p>
                          </div>
                        </div>
                      </div>
                      
                      <div className="border-t pt-6">
                        <h3 className="text-center text-gray-400 text-sm font-semibold mb-4">POSTS</h3>
                        <div className="grid grid-cols-3 gap-1">
                          {posts.filter(p => p.author?.username === user?.username).map((post, idx) => (
                            <div key={idx} className="aspect-square bg-gray-100 flex items-center justify-center">
                              {post.image_url ? (
                                <img src={post.image_url} alt={post.caption} className="w-full h-full object-cover" />
                              ) : (
                                <Icon icon={Camera} size={32} className="text-gray-400" />
                              )}
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </main>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<InstagramClone />);
    </script>
</body>
</html>